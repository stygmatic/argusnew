{
  "version": 3,
  "sources": ["../../../src/cli/insights.ts"],
  "sourcesContent": ["import { Command } from \"@commander-js/extra-typings\";\n// eslint-disable-next-line no-restricted-imports -- stdout output uses default chalk\nimport chalk from \"chalk\";\nimport { oneoffContext } from \"../bundler/context.js\";\nimport { logOutput } from \"../bundler/log.js\";\nimport {\n  deploymentSelectionWithinProjectFromOptions,\n  loadSelectedDeploymentCredentials,\n} from \"./lib/api.js\";\nimport { actionDescription } from \"./lib/command.js\";\nimport { deploymentDashboardUrlPage } from \"./lib/dashboard.js\";\nimport { getDeploymentSelection } from \"./lib/deploymentSelection.js\";\nimport { type Insight, fetchInsights } from \"./lib/insights.js\";\n\nfunction formatInsightKind(kind: string): string {\n  switch (kind) {\n    case \"occRetried\":\n      return \"OCC Retried\";\n    case \"occFailedPermanently\":\n      return \"OCC Failed Permanently\";\n    case \"bytesReadLimit\":\n      return \"Bytes Read Limit Exceeded\";\n    case \"bytesReadThreshold\":\n      return \"Bytes Read Near Limit\";\n    case \"documentsReadLimit\":\n      return \"Documents Read Limit Exceeded\";\n    case \"documentsReadThreshold\":\n      return \"Documents Read Near Limit\";\n    default:\n      return kind;\n  }\n}\n\nfunction formatFunctionName(insight: Insight): string {\n  if (insight.componentPath) {\n    return `${insight.componentPath}:${insight.functionId}`;\n  }\n  return insight.functionId;\n}\n\nfunction formatInsight(insight: Insight, details: boolean): string {\n  const severity =\n    insight.severity === \"error\"\n      ? chalk.red(`[ERROR]`)\n      : chalk.yellow(`[WARNING]`);\n  const kind = formatInsightKind(insight.kind);\n  const fn = chalk.bold(formatFunctionName(insight));\n\n  let detail: string;\n  if (\"occCalls\" in insight) {\n    const table = insight.occTableName\n      ? ` on table ${chalk.cyan(insight.occTableName)}`\n      : \"\";\n    detail = `${insight.occCalls} OCC conflict${insight.occCalls !== 1 ? \"s\" : \"\"}${table}`;\n  } else {\n    detail = `${insight.count} occurrence${insight.count !== 1 ? \"s\" : \"\"}`;\n  }\n\n  let output = `${severity} ${kind}: ${fn} \u2014 ${detail}`;\n\n  if (details && insight.recentEvents && insight.recentEvents.length > 0) {\n    output += \"\\n\";\n    for (const event of insight.recentEvents) {\n      const time = chalk.dim(new Date(event.timestamp).toLocaleString());\n      const reqId = chalk.dim(`req:${event.request_id}`);\n\n      if (\"occ_retry_count\" in event) {\n        const docId = event.occ_document_id\n          ? ` doc:${event.occ_document_id}`\n          : \"\";\n        const source = event.occ_write_source\n          ? ` source:${event.occ_write_source}`\n          : \"\";\n        output += `    ${time}  ${reqId}  retries:${event.occ_retry_count}${docId}${source}\\n`;\n      } else {\n        const status = event.success ? chalk.green(\"ok\") : chalk.red(\"fail\");\n        const calls = event.calls\n          .map(\n            (c) =>\n              `${c.table_name}(${c.documents_read} docs, ${c.bytes_read} bytes)`,\n          )\n          .join(\", \");\n        output += `    ${time}  ${reqId}  ${status}  ${calls}\\n`;\n      }\n    }\n  }\n\n  return output;\n}\n\nexport const insights = new Command(\"insights\")\n  .summary(\"Show health insights for your deployment\")\n  .description(\n    \"Show health insights for a Convex deployment over the last 72 hours.\\n\" +\n      \"Displays OCC conflicts and resource limit issues that may indicate performance problems.\\n\\n\" +\n      \"Only available for cloud deployments with user-level authentication.\",\n  )\n  .allowExcessArguments(false)\n  .option(\"--details\", \"Show recent events for each insight\", false)\n  .addDeploymentSelectionOptions(actionDescription(\"Show insights for\"))\n  .showHelpAfterError()\n  .action(async (cmdOptions) => {\n    const ctx = await oneoffContext(cmdOptions);\n\n    const selectionWithinProject =\n      deploymentSelectionWithinProjectFromOptions(cmdOptions);\n    const deploymentSelection = await getDeploymentSelection(ctx, cmdOptions);\n    const credentials = await loadSelectedDeploymentCredentials(\n      ctx,\n      deploymentSelection,\n      selectionWithinProject,\n    );\n\n    const deploymentName = credentials.deploymentFields?.deploymentName ?? null;\n    if (deploymentName === null) {\n      return await ctx.crash({\n        exitCode: 1,\n        errorType: \"fatal\",\n        printedMessage:\n          \"Insights are only available for cloud deployments. Local deployments do not have insights data.\",\n      });\n    }\n\n    const auth = ctx.bigBrainAuth();\n    if (\n      auth === null ||\n      auth.kind === \"deploymentKey\" ||\n      auth.kind === \"projectKey\"\n    ) {\n      return await ctx.crash({\n        exitCode: 1,\n        errorType: \"fatal\",\n        printedMessage:\n          \"Insights require user-level authentication. Deploy keys and project keys cannot access team usage data.\",\n      });\n    }\n\n    const insightsList = await fetchInsights(ctx, deploymentName, {\n      includeRecentEvents: cmdOptions.details,\n    });\n\n    const dashboardUrl = deploymentDashboardUrlPage(\n      deploymentName,\n      \"/insights\",\n    );\n\n    if (insightsList.length === 0) {\n      logOutput(\n        chalk.green(\n          \"No issues found. The deployment is healthy over the last 72 hours.\",\n        ),\n      );\n    } else {\n      const errorCount = insightsList.filter(\n        (i) => i.severity === \"error\",\n      ).length;\n      const warningCount = insightsList.filter(\n        (i) => i.severity === \"warning\",\n      ).length;\n\n      const parts: string[] = [];\n      if (errorCount > 0)\n        parts.push(\n          chalk.red(`${errorCount} error${errorCount > 1 ? \"s\" : \"\"}`),\n        );\n      if (warningCount > 0)\n        parts.push(\n          chalk.yellow(`${warningCount} warning${warningCount > 1 ? \"s\" : \"\"}`),\n        );\n      logOutput(`Found ${parts.join(\" and \")} in the last 72 hours:\\n`);\n\n      for (const insight of insightsList) {\n        logOutput(formatInsight(insight, cmdOptions.details));\n      }\n    }\n\n    logOutput(`\\nDashboard: ${chalk.cyan(dashboardUrl)}`);\n  });\n"],
  "mappings": "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",
  "names": []
}
