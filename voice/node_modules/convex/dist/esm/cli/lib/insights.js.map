{
  "version": 3,
  "sources": ["../../../../src/cli/lib/insights.ts"],
  "sourcesContent": ["import { Context } from \"../../bundler/context.js\";\nimport { fetchTeamAndProject } from \"./api.js\";\nimport { bigBrainFetch, provisionHost } from \"./utils/utils.js\";\n\nexport const ROOT_COMPONENT_PATH = \"-root-component-\";\n// Query ID for the insights dataset (shared with dashboard/src/api/insights.ts).\nexport const INSIGHTS_QUERY_ID = \"9ab3b74e-a725-480b-88a6-43e6bd70bd82\";\n\nexport type OccRecentEvent = {\n  timestamp: string;\n  id: string;\n  request_id: string;\n  occ_document_id?: string;\n  occ_write_source?: string;\n  occ_retry_count: number;\n};\n\nexport type ResourceRecentEvent = {\n  timestamp: string;\n  id: string;\n  request_id: string;\n  calls: {\n    table_name: string;\n    bytes_read: number;\n    documents_read: number;\n  }[];\n  success: boolean;\n};\n\nexport type OccInsight = {\n  kind: \"occRetried\" | \"occFailedPermanently\";\n  severity: \"error\" | \"warning\";\n  functionId: string;\n  componentPath: string | null;\n  occCalls: number;\n  occTableName?: string | undefined;\n  recentEvents?: OccRecentEvent[] | undefined;\n};\n\nexport type ResourceInsight = {\n  kind:\n    | \"bytesReadLimit\"\n    | \"bytesReadThreshold\"\n    | \"documentsReadLimit\"\n    | \"documentsReadThreshold\";\n  severity: \"error\" | \"warning\";\n  functionId: string;\n  componentPath: string | null;\n  count: number;\n  recentEvents?: ResourceRecentEvent[] | undefined;\n};\n\nexport type Insight = OccInsight | ResourceInsight;\n\n// Sorted from most to least severe.\nconst insightKinds: { kind: string; severity: \"error\" | \"warning\" }[] = [\n  { kind: \"documentsReadLimit\", severity: \"error\" },\n  { kind: \"bytesReadLimit\", severity: \"error\" },\n  { kind: \"occFailedPermanently\", severity: \"error\" },\n  { kind: \"documentsReadThreshold\", severity: \"warning\" },\n  { kind: \"bytesReadThreshold\", severity: \"warning\" },\n  { kind: \"occRetried\", severity: \"warning\" },\n];\n\nconst insightKindMap = new Map(\n  insightKinds.map((ik, i) => [ik.kind, { severity: ik.severity, order: i }]),\n);\n\nexport function orderForKind(kind: string): number {\n  return insightKindMap.get(kind)?.order ?? insightKinds.length;\n}\n\nexport function severityForKind(kind: string): \"error\" | \"warning\" | undefined {\n  return insightKindMap.get(kind)?.severity;\n}\n\nconst MAX_RECENT_EVENTS = 5;\n\nfunction parseRow(row: string[], includeRecentEvents: boolean): Insight | null {\n  const kind = row[0];\n  const functionId = row[1];\n  const componentPath = row[2] === ROOT_COMPONENT_PATH ? null : row[2];\n  const details = JSON.parse(row[3]);\n  const common = { functionId, componentPath };\n  const recentEvents = includeRecentEvents\n    ? (details.recentEvents as any[]).slice(0, MAX_RECENT_EVENTS)\n    : undefined;\n\n  switch (kind) {\n    case \"occRetried\":\n      return {\n        kind,\n        severity: \"warning\" as const,\n        ...common,\n        occCalls: details.occCalls,\n        occTableName: details.occTableName,\n        recentEvents,\n      };\n    case \"occFailedPermanently\":\n      return {\n        kind,\n        severity: \"error\" as const,\n        ...common,\n        occCalls: details.occCalls,\n        occTableName: details.occTableName,\n        recentEvents,\n      };\n    case \"bytesReadLimit\":\n      return {\n        kind,\n        severity: \"error\" as const,\n        ...common,\n        count: details.count,\n        recentEvents,\n      };\n    case \"bytesReadThreshold\":\n      return {\n        kind,\n        severity: \"warning\" as const,\n        ...common,\n        count: details.count,\n        recentEvents,\n      };\n    case \"documentsReadLimit\":\n      return {\n        kind,\n        severity: \"error\" as const,\n        ...common,\n        count: details.count,\n        recentEvents,\n      };\n    case \"documentsReadThreshold\":\n      return {\n        kind,\n        severity: \"warning\" as const,\n        ...common,\n        count: details.count,\n        recentEvents,\n      };\n    default:\n      return null;\n  }\n}\n\n/**\n * Fetch raw insight rows from the Big Brain usage API.\n * Returns the raw string[][] from the API response.\n */\nexport async function fetchRawInsightsData(\n  ctx: Context,\n  deploymentName: string,\n): Promise<string[][]> {\n  const { teamId } = await fetchTeamAndProject(ctx, deploymentName);\n\n  const now = new Date();\n  const hoursAgo72 = new Date(now.getTime() - 72 * 60 * 60 * 1000);\n  const fromDate = hoursAgo72.toISOString().split(\"T\")[0];\n  const toDate = now.toISOString().split(\"T\")[0];\n\n  const queryParams = new URLSearchParams({\n    queryId: INSIGHTS_QUERY_ID,\n    deploymentName,\n    from: fromDate,\n    to: toDate,\n  });\n  const bbFetch = await bigBrainFetch(ctx);\n  const res = await bbFetch(\n    `dashboard/teams/${teamId}/usage/query?${queryParams.toString()}`,\n    {\n      method: \"GET\",\n      headers: { Origin: provisionHost },\n    },\n  );\n  return (await res.json()) as string[][];\n}\n\n/**\n * Fetch and parse insights from the Big Brain usage API for a deployment.\n * Returns insights sorted by severity (errors first).\n *\n * Pass `includeRecentEvents: true` to include up to 5 recent events per insight.\n */\nexport async function fetchInsights(\n  ctx: Context,\n  deploymentName: string,\n  options?: { includeRecentEvents?: boolean },\n): Promise<Insight[]> {\n  const rawData = await fetchRawInsightsData(ctx, deploymentName);\n  const includeRecentEvents = options?.includeRecentEvents ?? false;\n\n  const insights: Insight[] = rawData.flatMap((row) => {\n    const parsed = parseRow(row, includeRecentEvents);\n    return parsed ? [parsed] : [];\n  });\n\n  insights.sort((a, b) => orderForKind(a.kind) - orderForKind(b.kind));\n  return insights;\n}\n"],
  "mappings": "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",
  "names": []
}
