{
  "version": 3,
  "sources": ["../../../../../../src/cli/lib/mcp/tools/insights.ts"],
  "sourcesContent": ["import { z } from \"zod\";\nimport { ConvexTool } from \"./index.js\";\nimport { loadSelectedDeploymentCredentials } from \"../../api.js\";\nimport { getDeploymentSelection } from \"../../deploymentSelection.js\";\nimport { deploymentDashboardUrlPage } from \"../../../lib/dashboard.js\";\nimport { fetchInsights } from \"../../insights.js\";\n\nconst inputSchema = z.object({\n  deploymentSelector: z\n    .string()\n    .describe(\n      \"Deployment selector (from the status tool) to fetch insights for.\",\n    ),\n});\n\nconst occRecentEventSchema = z.object({\n  timestamp: z.string(),\n  id: z.string(),\n  request_id: z.string(),\n  occ_document_id: z.string().optional(),\n  occ_write_source: z.string().optional(),\n  occ_retry_count: z.number(),\n});\n\nconst resourceRecentEventSchema = z.object({\n  timestamp: z.string(),\n  id: z.string(),\n  request_id: z.string(),\n  calls: z.array(\n    z.object({\n      table_name: z.string(),\n      bytes_read: z.number(),\n      documents_read: z.number(),\n    }),\n  ),\n  success: z.boolean(),\n});\n\nconst insightSchema = z.discriminatedUnion(\"kind\", [\n  z.object({\n    kind: z.literal(\"occRetried\"),\n    severity: z.literal(\"warning\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    occCalls: z.number(),\n    occTableName: z.string().optional(),\n    recentEvents: z.array(occRecentEventSchema),\n  }),\n  z.object({\n    kind: z.literal(\"occFailedPermanently\"),\n    severity: z.literal(\"error\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    occCalls: z.number(),\n    occTableName: z.string().optional(),\n    recentEvents: z.array(occRecentEventSchema),\n  }),\n  z.object({\n    kind: z.literal(\"bytesReadLimit\"),\n    severity: z.literal(\"error\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    count: z.number(),\n    recentEvents: z.array(resourceRecentEventSchema),\n  }),\n  z.object({\n    kind: z.literal(\"bytesReadThreshold\"),\n    severity: z.literal(\"warning\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    count: z.number(),\n    recentEvents: z.array(resourceRecentEventSchema),\n  }),\n  z.object({\n    kind: z.literal(\"documentsReadLimit\"),\n    severity: z.literal(\"error\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    count: z.number(),\n    recentEvents: z.array(resourceRecentEventSchema),\n  }),\n  z.object({\n    kind: z.literal(\"documentsReadThreshold\"),\n    severity: z.literal(\"warning\"),\n    functionId: z.string(),\n    componentPath: z.string().nullable(),\n    count: z.number(),\n    recentEvents: z.array(resourceRecentEventSchema),\n  }),\n]);\n\nconst outputSchema = z.object({\n  insights: z.array(insightSchema),\n  summary: z.string(),\n  dashboardUrl: z.string(),\n});\n\nconst description = `\nFetch health insights for a Convex deployment over the last 72 hours.\n\nReturns OCC (Optimistic Concurrency Control) conflicts and resource limit issues\nthat may indicate performance problems or failing functions.\n\n**OCC insights** (occRetried, occFailedPermanently):\n  Mutations that conflict on the same document. To fix: restructure mutations to\n  touch fewer shared documents, split hot documents, or reduce transaction scope.\n\n**Resource limit insights** (bytesReadLimit, documentsReadLimit, bytesReadThreshold, documentsReadThreshold):\n  Functions reading too much data. To fix: add indexes to avoid full table scans,\n  use pagination, or filter data more precisely in queries.\n\nSeverity levels:\n  - \"error\": Function executions are failing (permanent OCC failures or hard limits hit)\n  - \"warning\": Function executions succeed but are at risk (retried OCCs or approaching limits)\n\nUse the logs tool with status \"failure\" to see individual error messages and stack traces.\n\nOnly available for cloud deployments with user-level authentication.\n`.trim();\n\nexport const InsightsTool: ConvexTool<typeof inputSchema, typeof outputSchema> =\n  {\n    name: \"insights\",\n    description,\n    inputSchema,\n    outputSchema,\n    handler: async (ctx, args) => {\n      const { projectDir, deployment } = ctx.decodeDeploymentSelectorUnchecked(\n        args.deploymentSelector,\n      );\n      process.chdir(projectDir);\n      const deploymentSelection = await getDeploymentSelection(\n        ctx,\n        ctx.options,\n      );\n      const credentials = await loadSelectedDeploymentCredentials(\n        ctx,\n        deploymentSelection,\n        deployment,\n      );\n\n      const deploymentName =\n        credentials.deploymentFields?.deploymentName ?? null;\n      if (deploymentName === null) {\n        return await ctx.crash({\n          exitCode: 1,\n          errorType: \"fatal\",\n          printedMessage:\n            \"Insights are only available for cloud deployments. Local deployments do not have insights data.\",\n        });\n      }\n\n      const auth = ctx.bigBrainAuth();\n      if (\n        auth === null ||\n        auth.kind === \"deploymentKey\" ||\n        auth.kind === \"projectKey\"\n      ) {\n        return await ctx.crash({\n          exitCode: 1,\n          errorType: \"fatal\",\n          printedMessage:\n            \"Insights require user-level authentication. Deploy keys and project keys cannot access team usage data.\",\n        });\n      }\n\n      const insights = await fetchInsights(ctx, deploymentName, {\n        includeRecentEvents: true,\n      });\n\n      const errorCount = insights.filter((i) => i.severity === \"error\").length;\n      const warningCount = insights.filter(\n        (i) => i.severity === \"warning\",\n      ).length;\n\n      let summary: string;\n      if (insights.length === 0) {\n        summary =\n          \"No issues found. The deployment is healthy over the last 72 hours.\";\n      } else {\n        const parts: string[] = [];\n        if (errorCount > 0)\n          parts.push(`${errorCount} error${errorCount > 1 ? \"s\" : \"\"}`);\n        if (warningCount > 0)\n          parts.push(`${warningCount} warning${warningCount > 1 ? \"s\" : \"\"}`);\n        summary = `Found ${parts.join(\" and \")} in the last 72 hours.`;\n      }\n\n      const dashboardUrl = deploymentDashboardUrlPage(\n        deploymentName,\n        \"/insights\",\n      );\n\n      // Cast needed: fetchInsights returns Insight[] with optional recentEvents,\n      // but the zod schema requires them. They're always present when\n      // includeRecentEvents is true.\n      return {\n        insights: insights as z.infer<typeof insightSchema>[],\n        summary,\n        dashboardUrl,\n      };\n    },\n  };\n"],
  "mappings": "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",
  "names": []
}
